<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
      <meta name="description" content="">
      <meta name="author" content="">
      <script type="text/javascript" src="js/jquery.js" ></script>
      <title>AIZEAW- Inicio</title>
      <!-- Custom styles for this template-->
      <link href="css/sb-admin-2.min.css" rel="stylesheet">
      <!-- Bootstrap core JavaScript -->
      <script src="js/jquery.min.js"></script>
      <script src="js/bootstrap.bundle.min.js"></script><script type="text/javascript" src="js/bootstrap.min.js" ></script>
      <script type="text/javascript" src="js/jquery.js" ></script>
      <script type="text/javascript" src="js/script.js" ></script>
      <script src="js/jquery.datetimepicker.full.min.js"></script>
      <link rel="stylesheet" type="text/css" href="css/jquery.datetimepicker.css"/ >
      <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
      <link rel="stylesheet" type="text/css" href="css/estilos.css">
      <!-- Custom scripts for all pages-->
      <script src="js/sb-admin-2.min.js"></script>
      <!-- Page level plugins -->
      <script src="js/chart.js/Chart.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

   </head>
   <body id="page-top">
      <?php include 'php/db.php';?>
      <!-- Page Wrapper -->
      <div id="wrapper">
         <!-- Sidebar -->
         <div id="sidebarWrapper">
            <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
               <!-- Sidebar - Brand -->
               <a class="sidebar-brand d-flex align-items-center justifyhcontent-center" href="index.html">
                  <div class="sidebar-brand-icon rotate-n-15">
                     <i class="fas fa-laugh-wink"></i>
                  </div>
                  <div class="sidebar-brand-text mx-3">AIZEAW<sup><?php echo strtoupper($BX_local_name[0]);?></sup>

                  </div>
               </a>
               <!-- Divider -->
               <hr class="sidebar-divider my-0">
               <!-- Nav Item - Dashboard -->
               <li class="nav-item active">
                  <a class="nav-link" href="index.html">
                  <i class="fas fa-fw fa-tachometer-alt"></i>
                  <span onclick="setVariable(true)">Inicio</span>
                  </a>
               </li>
               <!-- Divider -->
               <hr class="sidebar-divider">
               <!-- Heading -->
               <div class="sidebar-heading">
                  Interface
               </div>
               <!-- Nav Item - Pages Collapse Menu -->
               <li class="nav-item">
                  <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseTwo"
                     aria-expanded="true" aria-controls="collapseTwo">
                  <i class="fas fa-fw fa-cog"></i>
                  <span>Todas las AIZEA</span>
                  </a>
                  <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionSidebar">
                     <div class="bp-white py-2 collapse-inner rounded">
                        <?php for ($j=0 ; $j < count($BX_alldevicedata) ; $j++ ){?>
                        <a class="collapse-item" href="http://<?php echo 	$BX_alldevicedata[$j][1];?>:20080/index.html" title="<?php echo 	$BX_alldevicedata[$j][1];?>"><?php echo 	$BX_alldevicedata[$j][0];?></a>
                        <?php } ?>
                     </div>
                  </div>
               </li>
               <!-- Nav Item - Utilities Collapse Menu -->
               <li class="nav-item">
                  <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseUtilities"
                     aria-expanded="true" aria-controls="collapseUtilities">
                  <i class="fas fa-fw fa-wrench"></i>
                  <span>Históricos</span>
                  </a>
                  <div id="collapseUtilities" class="collapse" aria-labelledby="headingUtilities"
                     data-parent="#accordionSidebar">
                     <div  id= "dateselector" class="row justify-content-center">
                        <b class="text-white">Start Date: </b> <input id="start_date" data-provide="datepicker">
                        <b class="text-white">End Date: </b> <input id="end_date" data-provide="datepicker">
                        <b></b>
                        <button class="btn btn-info" id="btn" onclick="setUpdateValue(false)" >Plot Values</button>
                     </div>
                  </div>
               </li>
               <!-- Nav Item - Utilities Collapse Menu -->
               <li class="nav-item">
                  <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseHistoricos"
                     aria-expanded="true" aria-controls="collapseHistoricos">
                  <i class="fas fa-fw fa-wrench"></i>
                  <span>Utilidades</span>
                  </a>
                  <div id="collapseHistoricos" class="collapse" aria-labelledby="headingUtilities"
                     data-parent="#accordionSidebar">
                     <div class="bg-white py-2 collapse-inner rounded">
                        <a class="collapse-item" href="config.html">Configuración Local</a>
                     </div>
                  </div>
               </li>
               <!-- Divider -->
               <hr class="sidebar-divider">
               <!-- Sidebar Toggler (Sidebar) -->
               <div class="text-center d-none d-md-inline">
                  <button class="rounded-circle border-0" id="sidebarToggle"></button>
               </div>
            </ul>
         </div> <!-- End of Sidebar -->
         <!-- Content Wrapper -->
         <div id="content-wrapper" class="d-flex flex-column">
            <!-- Main Content -->
            <div id="content">
               <!-- Topbar -->
               <nav class="navbar navbar-expand navbar-light bg-blue topbar mb-4 static-top shadow ">
                  <!-- Sidebar Toggle (Topbar) -->
                  <!-- Topbar Search -->
                  <img src="./img/aizea_logo_5.png" width="100" height="60" style="border: 2px solid blue;" alt="Aizea Logo" title="Aizea - Batela Soft." />
                  <div class="topbar-divider d-none d-sm-block"></div>
                  <h1 class="h1 mb-1 center" style="color: rgb(68, 114, 196); font-weight: bold;">AIZEAW</h1>
                  <p style="color: rgb(68, 114, 196); font-style: italic;">IND WEB</p>

                  <ul class="navbar-nav ml-auto">
                     <!-- Nav Item - Alerts -->
                     <li class="nav-item dropdown no-arrow mx-1">
                        <a class="nav-link dropdown-toggle" href="#" id="alertsDropdown" role="button"
                           data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                           <i class="fas fa-bell fa-fw" ></i>
                           <!-- Counter - Alerts -->
                           <span class="badge badge-danger badge-counter" title="Muestra las alarmas activas"><?php echo count($BX_alarmas)."+" ?></span>
                        </a>
                        <!-- Dropdown - Alerts -->
                        <div class="dropdown-list dropdown-menu dropdown-menu-right shadow animated--grow-in"
                           aria-labelledby="alertsDropdown">
                           <h6 class="dropdown-header">
                              Alarmas
                           </h6>
                           <?php foreach($BX_alarmas  as $a => $b) { ?>
                           <a class="dropdown-item d-flex align-items-center" href="#">
                              <div class="mr-3">
                                 <div class="icon-circle bg-primary">
                                    <i class="fas fa-file-alt text-white"></i>
                                 </div>
                              </div>
                              <div>
                                 <div class="small text-gray-500"><?php echo $BX_alarmas[$a][2]; ?></div>
                                 <span class="font-weight-bold"><?php echo $BX_alarmas[$a][0]." -> ".$BX_alarmas[$a][1]." km/h"; ?></span>
                              </div>
                           </a>
                           <?php } ?>
                           <form action="php/db.php" method="post">
                              <button type="submit" class="btn btn-info btn-block" name="reset_alarmas" ><i class="fa fa-plus"></i>Aceptar Todas</button>
                           </form>
                        </div>
                     </li>
                     <div class="topbar-divider d-none d-sm-block"></div>
                     <!-- Nav Item - User Information -->
                     <li class="nav-item dropdown no-arrow">
                        <a class="nav-link dropdown-toggle" href="#" id="MyuserDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span class="mr-2 d-none d-lg-inline text-gray-600 small"><?php echo $_SESSION["user"]; ?> </span>
                        <img class="img-profile rounded-circle" src="img/undraw_profile.svg">
                        </a>
                        <!-- Dropdown - User Information -->
                        <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in" aria-labelledby="MyuserDropdown">
                           <a class="dropdown-item" href="./login.html">
                           Logout
                           </a>
                        </div>
                     </li>
                  </ul>
               </nav> <!-- Topbar Navbar -->
               <div class="container-fluid ">
                  <div class="row position-relative ">
                      <!-- First Column -->
                    <div class="panel-group col-lg-3" id="accordionAizeaw">
                        <div class="card">
                           <h7 class="card-subtitle mt-1">AIZEAW Oficina</h7>
                            <div class="card-header text-left" style="background-color: rgb(165,191,221)" id="headingOne">
                              <div class="row">
                                  <div class="col-md-8" >
                                      <button  id = "vaisala01Data"  title="Ver ubicación" style="color: #000000;line-height:80%" class="btn btn-link text-center mt-0" data-toggle="collapse" data-target="#collapseOneA" aria-expanded="true" aria-controls="collapseOne">
                                        OFICINA
                                      </button>
                                  </div>
                                  <div class="col-md-4">
                                    <label id="vaisala01Dir"  style="color: #000000;line-height:80%" class="btn btn-link text-center mt-0"> XXX </label>
                                  </div>
                              </div>

                            </div>
                            <div id="collapseOneA" class="collapse show" aria-labelledby="headingOne" aria-expanded="true" data-parent="#accordionAizeaw">
                              <div class="card-body position-relative">
                                <img src="./img/AIZEAW_OFICINAS.bmp" class="card-img-top" style="z-index: 1;"/>
								<img id="arrowdir1" src="./img/Flecha2_V_N.bmp" class="position-absolute top-0 start-0" width="85" height="85" style="z-index: 2; left: 33%; top: 23% ;"/>
                              </div>
                            </div>
                            <div id="vaisala01Footer" class="card-footer text-muted">
                              <div class="row">
                                  <div id="vaisala01FooterC1" class="col-md-4" style="line-height:80%">
                                  </div>
                                  <div id="vaisala01FooterC2" class="col-md-4" style="line-height:80%">
                                  </div>
                                  <div id="vaisala01FooterC3" class="col-md-4" style="line-height:80%">
                                  </div>
                              </div>
                            </div>
                        </div>
                        <div class="card">
                            <h7 class="card-subtitle mt-1">AIZEAW Portainer 08</h7>
                            <div class="card-header" style="background-color: rgb(165,191,221)" id="headingTwo">
                              <div class="row">
                                  <div class="col-md-8" >
                                      <button  id = "vaisala02Data"  title="Ver ubicación" style="color: #000000;line-height:80%" class="btn btn-link text-center mt-0" data-toggle="collapse" data-target="#collapseTwoA" aria-expanded="false" aria-controls="collapseTwo">
                                        PORTAINER 08
                                      </button>
                                  </div>
                                  <div class="col-md-4">
                                    <!--img id="arrow01" class="" src="./img/Flecha2_R_N.bmp" width="55" height="55" /-->
                                    <label id="vaisala02Dir"  style="color: #000000;line-height:80%" class="btn btn-link text-center mt-0"> XXX </label>
                                  </div>
                              </div>
                            </div>
                            <div id="collapseTwoA" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionAizeaw">
                          
                              <div class="card-body position-relative">
                                <img src="../img/AIZEAW_GRUAP08.bmp" class="card-img-top" style="z-index: 1;"/>
								<img id="arrowdir2" src="./img/Flecha2_V_N.bmp" class="position-absolute top-0 start-0" width="85" height="85" style="z-index: 2; left: 33%; top: 23%;"/>
                              </div>
                            </div>
                            <div id="vaisala02Footer" class="card-footer text-muted">
                              <div class="row">
                                  <div id="vaisala02FooterC1" class="col-md-4" style="line-height:80%">
                                  </div>
                                  <div id="vaisala02FooterC2" class="col-md-4" style="line-height:80%">
                                  </div>
                                  <div id="vaisala02FooterC3" class="col-md-4" style="line-height:80%">
                                  </div>
                              </div>
                            </div>
                        </div>
                      </div>
                      <!-- Second Column -->
						<div class="col-lg-9">
                          <ul class="nav nav-tabs" id="myTab" role="tablist">
							<li class="nav-item">
								<a class="nav-link active" id="tab1-tab" data-toggle="tab" href="#tab1" role="tab" aria-controls="tab1" aria-selected="true">Tiempo Real</a>
							</li>
							<li class="nav-item">
								<a class="nav-link" id="tab2-tab" data-toggle="tab" href="#tab2" role="tab" aria-controls="tab2" aria-selected="false">Estadisticos</a>
							</li>
						</ul>
						<div class="tab-content" id="myTabContent">
							<div class="tab-pane fade show active" id="tab1" role="tabpanel" aria-labelledby="tab1-tab">
								<div id="lineChartId"></div>
								<div id="loader" class="loader"></div>
							</div>
							<div class="tab-pane fade" id="tab2" role="tabpanel" aria-labelledby="tab2-tab">
							    <div id="estadisticos"></div>
							</div>
						</div>  
                      </div>
                  </div>
               </div>
            </div> <!-- End of Main Content -->
            <!-- Footer -->
            <footer class="sticky-footer bg-white">
               <div class="container">
                  <div class="copyright text-center my-auto">
                     <span>Copyright &copy; BATELA SOFTWARE 2023</span>
                  </div>
               </div>
            </footer><!-- End of Footer -->
         </div><!-- End of Content Wrapper -->
      </div>  <!-- End of Page Wrapper -->
      <!-- Scroll to Top Button-->
      <a class="scroll-to-top rounded" href="#page-top">
      <i class="fas fa-angle-up"></i>
      </a>
      <!-- Page level custom scripts -->
      <script>
         // var enableUpdate ;
         // function autoRefresh (){
         //   if (enableUpdate == true){
         //      $('#windcaptops').load("windcaptops.html");
         //   }
         //
         // }
         function autoChartRefresh (){
           if (enableUpdate == true){
              $('#lineChartId').load("winddata.html");
              $('#estadisticos').load("estadisticos_radar.html");
            }
         }
         //setInterval ('autoRefresh()',2000);
         setInterval ('autoChartRefresh()',7000);
		
        $(document).ready(function()
        {
             $('#lineChartId').load("winddata.html");
             $('#windcaptops').load("windcaptops.html");
             $('#estadisticos').load("estadisticos_radar.html");
             $('#datetimepicker').datetimepicker();    
             enableUpdate = true ;
         });
           
         jQuery('#start_date').datetimepicker({
         format:'Y-m-d',
         lang:'es'
		 });
         
         jQuery('#end_date').datetimepicker({
         format:'Y-m-d',
         lang:'es'
         });

         const btn  = document.querySelector('#btn');
         btn.addEventListener('click',updateChart);

         function getWindDirectionLabel(degrees) {
            // Ensure degrees are within the range [0, 360)
            degrees = (degrees % 360 + 360) % 360;

            // Define wind directions and their corresponding labels
            // const directions = [
            //     "N", "NNE", "NE", "ENE",
            //     "E", "ESE", "SE", "SSE",
            //     "S", "SSW", "SW", "WSW",
            //     "W", "WNW", "NW", "NNW"
            // ];

            const directions = [
                "N", "NNE", "NE", "ENE",
                "E", "ESE", "SE", "SSE",
                "S", "SSO", "SO", "OSO",
                "O", "ONO", "NO", "NNO"
            ];
            const directionsText = [
                "Norte", "Nor-Noreste", "Noreste", "Este-Noreste",
                "Este", "Este-Sureste", "Sureste", "Sur-Sureste",
                "Sur", "Sur-Suroeste", "Suroeste", "Oeste-Suroeste",
                "Oeste", "Oeste-Noroeste", "Noroeste", "Nor-Noroeste"
            ];
            // Calculate the index based on the wind direction
            const index = Math.round(degrees / 22.5) % 16;

            // Return the corresponding wind label
            return [directions[index],directionsText[index]];
          }
          
          function fetchDataAndDisplay(rmurl1,vid,haizea_name) {
            //const rmurl1 = 'http://62.99.51.59:19099/api/v1/vaisaladata'; // Replace with your actual API URL
            var weatherData = [
                { vid: 1, element: vaisala01Dir,data: vaisala01Data, footer1:vaisala01FooterC1,footer2:vaisala01FooterC2,footer3:vaisala01FooterC3 },
                { vid: 2, element: vaisala02Dir,data: vaisala02Data, footer1:vaisala02FooterC1,footer2:vaisala02FooterC2,footer3:vaisala02FooterC3 },
                // Add more objects as needed
            ];
            //var vdata = weatherData[vid-1];
			
            fetch(rmurl1)
              .then(response => {
                // Check if the request was successful (status code 200-299)
                if (!response.ok) {
                  throw new Error(`HTTP error! Status: ${response.status}`);
                }
                // Parse the response body as JSON
                return response.json();
              })
              .then(data => {

                if (data.length > 0) {
					  // The array is not empty
					  console.log('Data array is not empty.');
					  // You can access the first element as mentioned before
					  const data00 = data[0];
					  var angle = data00.direction;
					  const speed = data00.speed;
					  const datadate = data00.dataDateStr;
					  
					  var arrowImage =	'./img/Flecha_V_N.bmp';
					  if (speed >= 80){
						  arrowImage =	'./img/Flecha_R_N.bmp';
					  }	
					  else if (speed >= 50) {
						  arrowImage =	'./img/Flecha_A_N.bmp';
					  }
					  const [worig,worigtext] = getWindDirectionLabel(angle);
					  angle = angle + 180;	
					  
					  if (haizea_name == "Oficina") {
						let vdata = weatherData[0];
			
						console.log ("Entramos en oficina");
						$("#arrowdir1").css({ transform: 'rotate(' + angle + 'deg)' });
						
						var imgElement = document.getElementById('arrowdir1');
						imgElement.src = arrowImage ; 
						
						var newRotationAngle = angle + 'deg';
						imgElement.style.transform = 'rotate(' + newRotationAngle + ')';
	   
						vdata.element.innerHTML = `<span class="text-center" style="font-size: 24px;"> ${worig}</span> <br>
												<span style="font-size: 10px;">${worigtext}</span>`;
						vdata.data.innerHTML = `<span class="text-center" style="font-size: 24px;"> ${speed} Km/h </span><br>
												<span style="font-size: 14px;">${datadate}</span>`;
						
						vdata.footer1.innerHTML =`<span class="text-left" style="font-size: 12px;">Mx 06H:</span> <span style="font-size: 12px;"> <?php echo $Max06HOficina; ?> </span> <br>
													  <span style="font-size: 12px;"> <?php echo $Max06HOficinaDate; ?></span>`;
						vdata.footer2.innerHTML =`<span class="text-left" style="font-size: 12px;">Mx 12H:</span> <span style="font-size: 12px;"> <?php echo $Max12HOficina; ?> </span> <br>
													 <span style="font-size: 12px;"> <?php echo $Max12HOficinaDate; ?> </span>`;
						vdata.footer3.innerHTML =`<span class="text-left" style="font-size: 12px;">Mx 24H:</span> <span style="font-size: 12px;"> <?php echo $Max24HOficina; ?> </span> <br>
													   <span style="font-size: 12px;"> <?php echo $Max24HOficinaDate; ?> </span>`;
                  }
                  else if (haizea_name == "Portainer08") {
						let vdata = weatherData[1];
						$("#arrowdir2").css({ transform: 'rotate(' + angle + 'deg)' });
						var imgElement = document.getElementById('arrowdir2');
						imgElement.src = arrowImage ;
						
						var newRotationAngle = angle + 'deg';
						imgElement.style.transform = 'rotate(' + newRotationAngle + ')';
						
						vdata.element.innerHTML = `<span class="text-center" style="font-size: 24px;"> ${worig}</span> <br>
												<span style="font-size: 10px;">${worigtext}</span>`;
						vdata.data.innerHTML = `<span class="text-center" style="font-size: 24px;"> ${speed} Km/h </span><br>
												<span style="font-size: 14px;">${datadate}</span>`;
						
						vdata.footer1.innerHTML =`<span class="text-left" style="font-size: 12px;">Mx 06H:</span> <span style="font-size: 12px;"> <?php echo $Max06HGrua; ?> </span> <br>
													  <span style="font-size: 12px;"> <?php echo $Max06HGruaDate; ?></span>`;
						vdata.footer2.innerHTML =`<span class="text-left" style="font-size: 12px;">Mx 12H:</span> <span style="font-size: 12px;"> <?php echo $Max12HGrua; ?> </span> <br>
													 <span style="font-size: 12px;"> <?php echo $Max12HGruaDate; ?> </span>`;
						vdata.footer3.innerHTML =`<span class="text-left" style="font-size: 12px;">Mx 24H:</span> <span style="font-size: 12px;"> <?php echo $Max24HGrua; ?> </span> <br>
													   <span style="font-size: 12px;"> <?php echo $Max24HGruaDate; ?> </span>`;
                  }

                } else {
                  vdata.data.innerHTML = `Error in Data`;
                }
              })
              .catch(error => {
                vdata.data.innerHTML = `NO DATA!!`;
                // vaisala02Data.innerHTML = `NO DATA!!`;
                // Handle any errors that occurred during the fetch
                console.error('Fetch error:', error);
              });
        }

        function sebtUpdateValue(value)
        {
            enableUpdate = value;
            console.log ("Update value set to: " + enableUpdate.toString());
        }

        function autoVaisalaDataRefresh (){
          var ip = "<?php echo $BX_alldevicedata[0][1]; ?>";
          const aizeaw01grua = "http://" + ip +":19099/api/v1/vaisaladata";
          console.log ("URL1:" + aizeaw01grua);
          fetchDataAndDisplay(aizeaw01grua,1,"<?php echo $BX_alldevicedata[0][0]; ?>");
		  //fetchDataAndDisplay(aizeaw01grua,1);
		  	
          ip = "<?php echo $BX_alldevicedata[1][1]; ?>";
          const aizeaw02grua = "http://" + ip +":19099/api/v1/vaisaladata";
          console.log ("URL1:" + aizeaw02grua);
          fetchDataAndDisplay(aizeaw02grua,2,"<?php echo $BX_alldevicedata[1][0]; ?>");
          //fetchDataAndDisplay(aizeaw02grua,2);
          
          //const url = "http://localhost:19099/api/v1/vaisaladata";
          //fetchDataAndDisplay('http://62.99.51.59:19099/api/v1/vaisaladata');
        }
        setInterval ('autoVaisalaDataRefresh()',2000);

      </script>
   </body>
</html>
